<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YBM BRILiaN Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Load PapaParse (Untuk membaca CSV Spreadsheet) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Google Fonts: MONTSERRAT -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
      body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; -webkit-font-smoothing: antialiased; }
      aside { will-change: transform; transform: translateZ(0); }
      ::-webkit-scrollbar { width: 4px; height: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      .iframe-container iframe { width: 100%; height: 100%; border: none; border-radius: 8px; }
      .animate-enter { animation: fadeInScale 0.4s ease-out forwards; }
      @keyframes fadeInScale { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }
      .markdown-body p { margin-bottom: 0.5em; }
      .markdown-body ul { list-style-type: disc; margin-left: 1.2em; }
      .active-border-bar { width: 100%; height: 2px; background: linear-gradient(90deg, transparent 0%, #2563eb 50%, transparent 100%); animation: slide 2s infinite linear; position: fixed; top: 6rem; z-index: 50; }
      @keyframes slide { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ==========================================
      // KONFIGURASI (ISI DATA ANDA DI SINI)
      // ==========================================
      
      // 1. Masukkan Link "Publish to web" (CSV) dari Spreadsheet Anda di sini:
      const GOOGLE_CSV_URL = "MASUKKAN_LINK_PUBLISH_TO_WEB_CSV_DISINI"; 
      
      // 2. Masukkan API Key Gemini Anda di sini:
      const GEMINI_API_KEY = "AIzaSyBDt3AHhYrLOFD8XZFTIsxsxoLC-qNnhbs"; 

      // ==========================================

      const { useState, useEffect, useRef } = React;
      
      // Icons
      const IconMenu = () => <i data-lucide="menu" className="w-5 h-5"></i>;
      const IconLock = () => <i data-lucide="lock" className="w-3 h-3"></i>;
      const IconShield = () => <i data-lucide="shield-check" className="w-12 h-12"></i>;
      const IconAlert = () => <i data-lucide="alert-circle" className="w-4 h-4"></i>;
      const IconXCircle = () => <i data-lucide="x-circle" className="w-16 h-16"></i>;
      const IconChevronDown = () => <i data-lucide="chevron-down" className="w-4 h-4"></i>;
      const IconFileText = () => <i data-lucide="file-text" className="w-4 h-4"></i>;
      const IconFolder = () => <i data-lucide="folder" className="w-4 h-4"></i>;
      const IconExternalLink = () => <i data-lucide="external-link" className="w-4 h-4"></i>;
      const IconHelp = () => <i data-lucide="help-circle" className="w-12 h-12"></i>;
      const IconLayout = () => <i data-lucide="layout" className="w-4 h-4"></i>;
      const IconMessageCircle = () => <i data-lucide="message-circle" className="w-6 h-6"></i>;
      const IconSend = () => <i data-lucide="send" className="w-4 h-4"></i>;
      const IconX = () => <i data-lucide="x" className="w-5 h-5"></i>;
      const IconBot = () => <i data-lucide="bot" className="w-6 h-6"></i>;

      // --- LOGIKA PARSING CSV MENJADI MENU TREE ---
      const parseCSVtoMenu = (csvText) => {
        return new Promise((resolve) => {
          Papa.parse(csvText, {
            header: true, // Baris pertama dianggap header
            skipEmptyLines: true,
            complete: function(results) {
              const data = results.data;
              const menuTree = [];

              data.forEach(row => {
                // Mapping nama kolom sesuai CSV Anda (pastikan header di sheet sama)
                // Asumsi kolom: "Menu Utama", "Sub Menu 1", dst.
                // Jika header di sheet beda, sesuaikan string di bawah ini.
                const levels = [
                  row['Menu Utama'], row['Sub Menu 1'], row['Sub Menu 2'], 
                  row['Sub Menu 3'], row['Sub Menu 4'], row['Sub Menu 5']
                ];
                const link = row['Sumber Link'] || row['Link'] || ''; // Coba tangkap kolom Link

                let currentLevel = menuTree;

                for (let i = 0; i < levels.length; i++) {
                  const menuName = levels[i];
                  if (!menuName || menuName === "-" || menuName.trim() === "") break;

                  let existingMenu = currentLevel.find(item => item.name === menuName);
                  if (existingMenu) {
                    currentLevel = existingMenu.children;
                  } else {
                    let newNode = {
                      id: crypto.randomUUID(),
                      name: menuName,
                      children: [],
                      link: null
                    };
                    currentLevel.push(newNode);
                    currentLevel = newNode.children;
                  }

                  // Cek apakah ini level terakhir yang valid untuk baris ini
                  const isLast = (i === levels.length - 1) || (!levels[i+1] || levels[i+1] === "-");
                  if (isLast) {
                    // Set link pada node yang baru saja dibuat/ditemukan
                    // Kita cari ulang node-nya di array parent (currentLevel sebelumnya)
                    // Tapi karena pointer sudah pindah, cara termudah:
                    // Akses node terakhir di array tempat kita push tadi.
                    // Pointer 'currentLevel' sekarang menunjuk ke 'children' dari node baru.
                    // Jadi link harus di-set pada parent dari pointer 'currentLevel' sekarang? 
                    // Tidak, logic ini agak tricky. Mari sederhanakan:
                    
                    // Kita ulangi pencarian node terakhir
                    // (Atau simpan referensi node saat loop)
                  }
                }
              });
              
              // RE-BUILDING LOGIC YANG LEBIH SIMPEL DAN AKURAT
              const finalTree = [];
              data.forEach(row => {
                let currentLevel = finalTree;
                const link = row['Sumber Link'] || row['Link'];
                
                const cols = ['Menu Utama', 'Sub Menu 1', 'Sub Menu 2', 'Sub Menu 3', 'Sub Menu 4', 'Sub Menu 5'];
                let path = [];
                
                // Ambil semua level menu yang valid
                for(let col of cols) {
                   if(row[col] && row[col] !== "-") path.push(row[col]);
                   else break;
                }
                
                path.forEach((name, index) => {
                   let node = currentLevel.find(n => n.name === name);
                   if(!node) {
                      node = { id: Math.random().toString(36).substr(2, 9), name: name, children: [], link: null };
                      currentLevel.push(node);
                   }
                   
                   // Jika ini adalah item terakhir di path, pasang linknya
                   if(index === path.length - 1) {
                      node.link = link;
                   }
                   
                   currentLevel = node.children;
                });
              });

              resolve(finalTree);
            }
          });
        });
      };

      // --- CHAT WIDGET (Direct Fetch Gemini) ---
      const ChatWidget = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [messages, setMessages] = useState([{ sender: 'ai', text: 'Halo! Saya **YBM Assistant**. Ada yang bisa saya bantu?' }]);
        const [input, setInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const messagesEndRef = useRef(null);

        useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);
        useEffect(() => { if (isOpen && window.lucide) setTimeout(() => window.lucide.createIcons(), 50); }, [isOpen, messages]);

        const handleSend = async () => {
          if (!input.trim() || isLoading) return;
          const userMsg = { sender: 'user', text: input };
          setMessages(prev => [...prev, userMsg]);
          setInput('');
          setIsLoading(true);

          try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ contents: [{ parts: [{ text: userMsg.text }] }] })
            });
            const data = await response.json();
            
            if (data.candidates && data.candidates.length > 0) {
               setMessages(prev => [...prev, { sender: 'ai', text: data.candidates[0].content.parts[0].text }]);
            } else {
               setMessages(prev => [...prev, { sender: 'ai', text: 'Maaf, saya tidak mengerti.' }]);
            }
          } catch (error) {
            setMessages(prev => [...prev, { sender: 'ai', text: 'Gagal terhubung ke AI.' }]);
          } finally {
            setIsLoading(false);
          }
        };

        const renderText = (text) => {
          return { __html: (typeof marked !== 'undefined' && marked.parse) ? marked.parse(text) : text };
        };

        return (
          <>
            <button onClick={() => setIsOpen(!isOpen)} className={`fixed bottom-6 right-6 z-50 p-3 rounded-full shadow-xl transition-transform hover:scale-105 ${isOpen ? 'bg-red-500 rotate-90' : 'bg-blue-600'} text-white flex justify-center items-center w-14 h-14`}>
              {isOpen ? <IconX /> : <IconMessageCircle />}
            </button>
            {isOpen && (
              <div className="fixed bottom-24 right-6 w-80 md:w-96 h-[450px] bg-white rounded-2xl shadow-2xl border border-slate-200 z-50 flex flex-col overflow-hidden animate-enter origin-bottom-right">
                <div className="bg-blue-600 p-4 text-white flex items-center gap-3 shadow-md">
                  <div className="bg-white/20 p-2 rounded-full"><IconBot /></div>
                  <div><h3 className="font-bold text-sm">YBM Assistant</h3><p className="text-[10px] text-blue-100">Online â€¢ Direct API</p></div>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                  {messages.map((msg, idx) => (
                    <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${msg.sender === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-slate-800 rounded-tl-none markdown-body'}`}>
                        {msg.sender === 'ai' ? <div dangerouslySetInnerHTML={renderText(msg.text)} /> : msg.text}
                      </div>
                    </div>
                  ))}
                  {isLoading && <div className="text-xs text-slate-400 italic p-4">Sedang mengetik...</div>}
                  <div ref={messagesEndRef}></div>
                </div>
                <div className="p-3 bg-white border-t border-slate-200 flex gap-2">
                  <input type="text" className="flex-1 px-4 py-2 bg-slate-100 rounded-full text-sm outline-none" placeholder="Tanya sesuatu..." value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()} disabled={isLoading} />
                  <button onClick={handleSend} disabled={isLoading} className="p-2 bg-blue-600 text-white rounded-full"><IconSend /></button>
                </div>
              </div>
            )}
          </>
        );
      };

      // --- MAIN APP ---
      const MenuItem = ({ item, level, onSelect, activeId }) => {
        const [isOpen, setIsOpen] = useState(false);
        const hasChildren = item.children && item.children.length > 0;
        const isActive = activeId === item.id;
        const handleClick = (e) => { e.stopPropagation(); if (hasChildren) setIsOpen(!isOpen); else onSelect(item); };
        
        return (
          <div className="mb-1 select-none">
            <div onClick={handleClick} className={`group flex items-center justify-between py-2.5 pr-3 cursor-pointer rounded-lg mx-3 transition-all duration-200 border border-transparent ${isActive ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-600 hover:bg-slate-50'}`} style={{ paddingLeft: `${level * 12 + 16}px` }}>
              <div className="flex items-center gap-3 overflow-hidden">
                <span>{hasChildren ? <IconFolder /> : <IconFileText />}</span>
                <span className="text-sm truncate font-medium">{item.name}</span>
              </div>
              {hasChildren && <span className={`transform transition-transform ${isOpen ? 'rotate-180' : ''}`}><IconChevronDown /></span>}
            </div>
            {hasChildren && isOpen && <div className="mt-1">{item.children.map(child => <MenuItem key={child.id} item={child} level={level + 1} onSelect={onSelect} activeId={activeId} />)}</div>}
          </div>
        );
      };

      const App = () => {
        const [menuData, setMenuData] = useState([]);
        const [loading, setLoading] = useState(true);
        const [selectedItem, setSelectedItem] = useState(null);
        const [sidebarOpen, setSidebarOpen] = useState(true);
        const [isAccessError, setIsAccessError] = useState(false);

        useEffect(() => {
          // FETCH DATA LANGSUNG DARI CSV GOOGLE SHEETS
          fetch(GOOGLE_CSV_URL)
            .then(res => res.text())
            .then(text => parseCSVtoMenu(text))
            .then(data => {
              setMenuData(data);
              setLoading(false);
            })
            .catch(err => {
              console.error("Gagal mengambil data", err);
              setLoading(false);
            });
        }, []);

        useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [menuData, sidebarOpen, selectedItem, loading, isAccessError]);

        const handleSelect = (item) => { setSelectedItem(item); setIsAccessError(false); if (window.innerWidth < 768) setSidebarOpen(false); };
        const openPopupWindow = (url) => { window.open(url, 'Popup', 'width=1000,height=650'); };

        const renderContent = () => {
           if (!selectedItem) return (
            <div className="flex flex-col items-center justify-center h-full bg-white/50 p-6">
              <div className="bg-white p-8 rounded-2xl shadow-xl shadow-slate-100 max-w-2xl text-center border border-white">
                <div className="mb-6 inline-flex p-4 rounded-full bg-blue-50 text-blue-600"><IconShield /></div>
                <h1 className="text-2xl font-bold text-slate-800 mb-2">Assalamualaikum, Insan BRILiaN</h1>
                <p className="text-slate-500 mb-6">Selamat Datang di Portal Data Terintegrasi</p>
                <div className="h-px w-24 bg-slate-200 mx-auto mb-6"></div>
                <p className="text-slate-600 mb-8">Sistem ini menyediakan akses terpusat ke dashboard monitoring.</p>
                <div className="bg-red-50 border border-red-100 rounded-lg p-4 inline-block mx-auto"><p className="text-red-600 text-sm font-semibold flex items-center justify-center gap-2"><IconAlert />Mohon jaga kerahasiaan data.</p></div>
              </div>
              <p className="mt-8 text-slate-400 text-xs text-center">&copy; {new Date().getFullYear()} YBM BRILiaN</p>
            </div>
           );
           
           if (isAccessError) return (
             <div className="flex flex-col items-center justify-center h-full p-6 text-center">
               <h2 className="text-xl font-bold mb-2">Kendala Tampilan</h2>
               <p className="mb-4 text-sm text-slate-600">Klik tombol di bawah untuk membuka di jendela baru.</p>
               <button onClick={() => openPopupWindow(selectedItem.link)} className="px-4 py-2 bg-blue-600 text-white rounded font-bold shadow-lg flex items-center gap-2 mx-auto"><IconLayout className="w-4 h-4" /> Buka Jendela Popup</button>
               <button onClick={() => setIsAccessError(false)} className="mt-4 text-sm text-slate-500 block mx-auto">Kembali</button>
             </div>
           );
           
           let src = selectedItem.link;
           // Auto-fix link sharepoint
           if (src && src.includes("sharepoint") && !src.includes("embedview")) src += src.includes("?") ? "&action=embedview" : "?action=embedview";
           
           return (
             <div className="flex flex-col h-full relative">
                <iframe src={src} className="w-full h-full bg-white shadow-inner" allowFullScreen></iframe>
                <div className="absolute bottom-4 right-4 z-20">
                  <button onClick={() => setIsAccessError(true)} className="flex items-center gap-2 px-4 py-2 bg-white/90 shadow-lg rounded-full text-xs font-bold text-slate-600 hover:text-red-600">
                    <IconAlert /> Kendala Tampilan?
                  </button>
                </div>
             </div>
           );
        };

        if (loading) return (
          <div className="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
            <img src="https://ybmbrilian.id/wp-content/themes/ybmbrilian/assets/images/logo-ybm-brilian-100x95.png" className="w-24 mb-8 animate-pulse" />
            <h1 className="text-xl font-bold text-slate-800">YBM BRILiaN</h1>
            <p className="text-sm font-medium text-blue-600 uppercase tracking-widest">Memuat Data...</p>
          </div>
        );

        return (
          <div className="flex h-screen bg-[#F8FAFC]">
            <ChatWidget />
            <aside className={`fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
               <div className="h-24 flex items-center px-6 border-b border-slate-200 font-bold text-slate-800">YBM BRILiaN</div>
               <div className="flex-1 overflow-y-auto py-6 custom-scrollbar">
                 {menuData.map(item => <MenuItem key={item.id} item={item} level={0} onSelect={handleSelect} activeId={selectedItem?.id} />)}
               </div>
            </aside>
            <main className="flex-1 flex flex-col h-full overflow-hidden relative">
               <header className="h-24 bg-white flex items-center justify-between px-6 shadow-sm z-20 border-b border-slate-200">
                 <button className="md:hidden" onClick={() => setSidebarOpen(!sidebarOpen)}><IconMenu /></button>
                 <div className="font-bold text-slate-800">Link Terintegrasi</div>
               </header>
               <div className="flex-1 overflow-auto p-6">{renderContent()}</div>
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
